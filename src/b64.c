#include "b64.h"

// the conversion table for base46 encoding/decoding
const char* b64Table = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
const char b64DecTable[] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0x3e, 0xff, 0xff, 0xff, 0x3f, 
    0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 
    0x3c, 0x3d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 
    0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 
    0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 
    0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 
    0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 
    0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 
    0x31, 0x32, 0x33, 0xff, 0xff, 0xff, 0xff, 0xff
};

// encodes a block 3 (or less) bytes from src, and writes
// the base64 encoded data in dst. If length > 3, the function
// will only encode 3 bytes of data
void encode(const byte* src, byte* dst, unsigned int length)
{
    int i, j, k, l;
    switch (length)
    {
    case 1:
        i = src[0]>>2;
        j = (src[0]&3) << 4;
        k = 64; l = 64;
        break;
    case 2:
        i = src[0]>>2;
        j = ((src[0]&3)<<4) | (src[1]>>4);
        k = (src[1] & 15)<<2;
        l = 64;
        break;
    default:
        i = src[0]>>2;
        j = ((src[0]&3)<<4) | (src[1]>>4);
        k = ((src[1] & 0xf) << 2) | (src[2]>>6 & 3);
        l = src[2] & 0x3f;
        break;
    }
    dst[0] = b64Table[i]; 
    dst[1] = b64Table[j];
    dst[2] = b64Table[k]; 
    dst[3] = b64Table[l];
}
// reads a 4-character long base64 encoded string src, and writes the
// decoded bytes in dst
int decode(const byte* src, byte* dst)
{
    int x = 0, l = 0;
    while(src[l] != '=' && l<4)l++;
    for (int i = 0; i < l; i++)
    {
        int index = b64DecTable[src[i]];
        if(index == 0xff) return 0;
        x |= index << 6*(l-1-i);
    }
    if(l==2) x>>=4;
    else if(l==3) x>>=2;
    --l;
    for(int i=0; i < l; i++)
        dst[i] = (x >> (8*(l-1-i))) & 0xff;
    return l;
}